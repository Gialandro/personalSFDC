name: Deploy in SFDC
on:
  pull_request:
    types: [synchronize]
    branches: [master]
    paths:
      - "force-app/**"
  push:
    branches: [master]
    paths:
      - "force-app/**"
jobs:
  steps-to-deploy:
    runs-on: ubuntu-latest
    container: 
      image: salesforce/salesforcedx:latest-rc-full
    steps:
      # * Check repo and previous commits for delta deploy (SFDX plugin)
      - uses: actions/checkout@v3
        with:
          ref: ${{github.ref}}
          fetch-depth: 0
      # * Use Node 16 for SFDX CLI
      - uses: actions/setup-node@v3
        with:
          check-latest: true
      # * Update CLI (just in case)
      - name: Update CLI
        run: |
          sfdx update
          git config --global --add safe.directory /__w/personalSFDC/personalSFDC
      # * Install SFDX Delta plugin (deploy only detected changes)
      - name: Install SFDX Git Delta
        run: |
          echo y | sfdx plugins:install sfdx-git-delta
      # * Install SFDX Scanner plugin (check PMD rules in the repo) and check list of plugins
      # - name: Install SFDX Scanner
      #   run: |
      #     echo y | sfdx plugins:install @salesforce/sfdx-scanner
      #     sfdx plugins
      # * Add URL from secret in repo
      - name: Add URL from repo
        shell: bash
        run: |
          echo ${{secrets.SFDX_AUTH_URI}} > INSTANCE_URL
          TESTS=$(cat tests/master.txt)
          echo "APEX_TESTS=$TESTS" $GITHUB_ENV
      # * Login in SFDC instance
      - name: Login in Salesforce
        run: |
          echo env.APEX_TESTS
          sfdx force:auth:sfdxurl:store -f INSTANCE_URL -s -a sfdcInstance
      # * Deploy Delta changes
      - name: Create Delta
        run: |
          sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --generate-delta --output . --source force-app/
      # * Run Specified tests
      - name: Run one tests
        run: |
          sfdx force:apex:test:run --classnames "AccountManagerTest,LeadProcessorTest" --codecoverage --resultformat human
      # # * Run Tests
      - name: Run All tests
        run: |
          sfdx force:apex:test:run --testlevel RunLocalTests --codecoverage --resultformat human
      # * Run test with deploy method
      # - name: Test with Deploy method
      #   run: |
      #     sfdx force:source:deploy -p "force-app" --checkonly --testlevel RunSpecifiedTests --runtests "AccountManagerTest" --json
      # * Deploy changes
      - name: Deploy to SFDC
        run: |
          sfdx force:source:deploy -x package/package.xml --postdestructivechanges destructiveChanges/destructiveChanges.xml